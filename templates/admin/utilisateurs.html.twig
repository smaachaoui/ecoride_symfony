{# templates/admin/utilisateurs.html.twig #}

{% extends 'admin/index.html.twig' %}

{% block title %}Gestion des utilisateurs - Admin EcoRide{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 text-dark-green mb-0">
        <i class="bi bi-people me-2"></i>Gestion des utilisateurs
    </h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCreerUtilisateur">
        <i class="bi bi-plus-circle me-1"></i>Créer un utilisateur
    </button>
</div>

{# Filtres et recherche #}
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <form method="GET" action="{{ path('app_admin_utilisateurs') }}" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="search" class="form-label">Rechercher</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="{{ search }}" placeholder="Pseudo, email...">
            </div>
            <div class="col-md-3">
                <label for="role" class="form-label">Rôle</label>
                <select class="form-select" id="role" name="role">
                    <option value="">Tous les rôles</option>
                    <option value="PASSAGER" {{ roleFilter == 'PASSAGER' ? 'selected' : '' }}>Passager</option>
                    <option value="CHAUFFEUR" {{ roleFilter == 'CHAUFFEUR' ? 'selected' : '' }}>Chauffeur</option>
                    <option value="CHAUFFEUR_PASSAGER" {{ roleFilter == 'CHAUFFEUR_PASSAGER' ? 'selected' : '' }}>Chauffeur & Passager</option>
                    <option value="EMPLOYE" {{ roleFilter == 'EMPLOYE' ? 'selected' : '' }}>Employé</option>
                    <option value="ADMIN" {{ roleFilter == 'ADMIN' ? 'selected' : '' }}>Admin</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="statut" class="form-label">Statut</label>
                <select class="form-select" id="statut" name="statut">
                    <option value="">Tous les statuts</option>
                    <option value="actif" {{ statutFilter == 'actif' ? 'selected' : '' }}>Actif</option>
                    <option value="suspendu" {{ statutFilter == 'suspendu' ? 'selected' : '' }}>Suspendu</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1"></i>Filtrer
                </button>
            </div>
        </form>
    </div>
</div>

{# Bouton recharger crédits pour tous #}
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title text-dark-green">
            <i class="bi bi-coin me-2"></i>Recharger les crédits
        </h5>
        <form method="POST" action="{{ path('app_admin_recharger_credits_tous') }}" class="row g-3 align-items-end">
            <input type="hidden" name="_token" value="{{ csrf_token('recharger_credits_tous') }}">
            <div class="col-md-4">
                <label for="montant" class="form-label">Montant de crédits</label>
                <input type="number" class="form-control" id="montant" name="montant" min="0" value="20" required>
            </div>
            <div class="col-md-4">
                <label for="mode" class="form-label">Mode</label>
                <select class="form-select" id="mode" name="mode">
                    <option value="ajouter">Ajouter aux crédits existants</option>
                    <option value="definir">Définir (remplacer)</option>
                </select>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-success w-100" 
                        onclick="return confirm('Êtes-vous sûr de vouloir modifier les crédits de tous les utilisateurs ?')">
                    <i class="bi bi-coin me-1"></i>Appliquer à tous les utilisateurs
                </button>
            </div>
        </form>
        <small class="text-muted mt-2 d-block">
            <i class="bi bi-info-circle me-1"></i>
            Cette action affecte tous les utilisateurs (passagers et chauffeurs), mais pas les employés ni les admins.
        </small>
    </div>
</div>

{# Liste des utilisateurs #}
<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th>ID</th>
                        <th>Utilisateur</th>
                        <th>Email</th>
                        <th>Rôle</th>
                        <th>Crédits</th>
                        <th>Statut</th>
                        <th>Inscrit le</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for utilisateur in utilisateurs %}
                        <tr class="{{ utilisateur.isSuspended ? 'table-danger' : '' }}">
                            <td>{{ utilisateur.id }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if utilisateur.photo %}
                                        <img src="{{ asset('uploads/photos/' ~ utilisateur.photo) }}" 
                                             alt="{{ utilisateur.pseudo }}" 
                                             class="rounded-circle me-2"
                                             width="32" height="32"
                                             style="object-fit: cover;">
                                    {% else %}
                                        <div class="rounded-circle bg-light-green d-flex align-items-center justify-content-center me-2" 
                                             style="width: 32px; height: 32px;">
                                            <i class="bi bi-person text-dark-green small"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <strong>{{ utilisateur.pseudo }}</strong>
                                        {% if utilisateur.isAdmin %}
                                            <span class="badge bg-danger ms-1">Admin</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>{{ utilisateur.email }}</td>
                            <td>
                                {% if utilisateur.role == 'PASSAGER' %}
                                    <span class="badge bg-info">Passager</span>
                                {% elseif utilisateur.role == 'CHAUFFEUR' %}
                                    <span class="badge bg-primary">Chauffeur</span>
                                {% elseif utilisateur.role == 'CHAUFFEUR_PASSAGER' %}
                                    <span class="badge bg-success">Chauffeur & Passager</span>
                                {% elseif utilisateur.role == 'EMPLOYE' %}
                                    <span class="badge bg-warning text-dark">Employé</span>
                                {% elseif utilisateur.role == 'ADMIN' %}
                                    <span class="badge bg-danger">Admin</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-coin me-1"></i>{{ utilisateur.credits }}
                                </span>
                            </td>
                            <td>
                                {% if utilisateur.isSuspended %}
                                    <span class="badge bg-danger">Suspendu</span>
                                {% else %}
                                    <span class="badge bg-success">Actif</span>
                                {% endif %}
                            </td>
                            <td>{{ utilisateur.createdAt|date('d/m/Y') }}</td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    {# Modifier les crédits #}
                                    <button type="button" class="btn btn-outline-success" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalCredits{{ utilisateur.id }}"
                                            title="Modifier les crédits">
                                        <i class="bi bi-coin"></i>
                                    </button>
                                    
                                    {# Modifier #}
                                    <button type="button" class="btn btn-outline-primary" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalModifier{{ utilisateur.id }}"
                                            title="Modifier">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    
                                    {# Suspendre/Réactiver #}
                                    {% if not utilisateur.isAdmin %}
                                        {% if utilisateur.isSuspended %}
                                            <form action="{{ path('app_admin_reactiver', {'id': utilisateur.id}) }}" 
                                                  method="POST" class="d-inline">
                                                <input type="hidden" name="_token" value="{{ csrf_token('reactiver_' ~ utilisateur.id) }}">
                                                <button type="submit" class="btn btn-outline-success" title="Réactiver">
                                                    <i class="bi bi-check-circle"></i>
                                                </button>
                                            </form>
                                        {% else %}
                                            <form action="{{ path('app_admin_suspendre', {'id': utilisateur.id}) }}" 
                                                  method="POST" class="d-inline">
                                                <input type="hidden" name="_token" value="{{ csrf_token('suspendre_' ~ utilisateur.id) }}">
                                                <button type="submit" class="btn btn-outline-warning" title="Suspendre"
                                                        onclick="return confirm('Suspendre cet utilisateur ?')">
                                                    <i class="bi bi-pause-circle"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                        
                                        {# Supprimer #}
                                        <form action="{{ path('app_admin_utilisateur_supprimer', {'id': utilisateur.id}) }}" 
                                              method="POST" class="d-inline">
                                            <input type="hidden" name="_token" value="{{ csrf_token('supprimer_utilisateur_' ~ utilisateur.id) }}">
                                            <button type="submit" class="btn btn-outline-danger" title="Supprimer"
                                                    onclick="return confirm('Êtes-vous sûr de vouloir supprimer définitivement cet utilisateur ?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>

                        {# Modal Modifier Crédits #}
                        <div class="modal fade" id="modalCredits{{ utilisateur.id }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form action="{{ path('app_admin_utilisateur_credits', {'id': utilisateur.id}) }}" method="POST">
                                        <input type="hidden" name="_token" value="{{ csrf_token('credits_' ~ utilisateur.id) }}">
                                        <div class="modal-header">
                                            <h5 class="modal-title">
                                                <i class="bi bi-coin me-2"></i>Modifier les crédits
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Utilisateur : <strong>{{ utilisateur.pseudo }}</strong></p>
                                            <div class="mb-3">
                                                <label for="credits{{ utilisateur.id }}" class="form-label">Nombre de crédits</label>
                                                <input type="number" class="form-control" id="credits{{ utilisateur.id }}" 
                                                       name="credits" value="{{ utilisateur.credits }}" min="0" required>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                            <button type="submit" class="btn btn-success">Enregistrer</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        {# Modal Modifier Utilisateur #}
                        <div class="modal fade" id="modalModifier{{ utilisateur.id }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form action="{{ path('app_admin_utilisateur_modifier', {'id': utilisateur.id}) }}" method="POST">
                                        <input type="hidden" name="_token" value="{{ csrf_token('modifier_utilisateur_' ~ utilisateur.id) }}">
                                        <div class="modal-header">
                                            <h5 class="modal-title">
                                                <i class="bi bi-pencil me-2"></i>Modifier l'utilisateur
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label for="pseudo{{ utilisateur.id }}" class="form-label">Pseudo *</label>
                                                <input type="text" class="form-control" id="pseudo{{ utilisateur.id }}" 
                                                       name="pseudo" value="{{ utilisateur.pseudo }}" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="email{{ utilisateur.id }}" class="form-label">Email *</label>
                                                <input type="email" class="form-control" id="email{{ utilisateur.id }}" 
                                                       name="email" value="{{ utilisateur.email }}" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="password{{ utilisateur.id }}" class="form-label">
                                                    Nouveau mot de passe <small class="text-muted">(laisser vide pour ne pas changer)</small>
                                                </label>
                                                <input type="password" class="form-control" id="password{{ utilisateur.id }}" 
                                                       name="password" minlength="8">
                                            </div>
                                            {% if not utilisateur.isAdmin %}
                                                <div class="mb-3">
                                                    <label for="role{{ utilisateur.id }}" class="form-label">Rôle</label>
                                                    <select class="form-select" id="role{{ utilisateur.id }}" name="role">
                                                        <option value="PASSAGER" {{ utilisateur.role == 'PASSAGER' ? 'selected' : '' }}>Passager</option>
                                                        <option value="CHAUFFEUR" {{ utilisateur.role == 'CHAUFFEUR' ? 'selected' : '' }}>Chauffeur</option>
                                                        <option value="CHAUFFEUR_PASSAGER" {{ utilisateur.role == 'CHAUFFEUR_PASSAGER' ? 'selected' : '' }}>Chauffeur & Passager</option>
                                                        <option value="EMPLOYE" {{ utilisateur.role == 'EMPLOYE' ? 'selected' : '' }}>Employé</option>
                                                    </select>
                                                </div>
                                            {% endif %}
                                            <div class="mb-3">
                                                <label for="creditsEdit{{ utilisateur.id }}" class="form-label">Crédits</label>
                                                <input type="number" class="form-control" id="creditsEdit{{ utilisateur.id }}" 
                                                       name="credits" value="{{ utilisateur.credits }}" min="0">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0">Aucun utilisateur trouvé</p>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{# Modal Créer Utilisateur #}
<div class="modal fade" id="modalCreerUtilisateur" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ path('app_admin_utilisateur_creer') }}" method="POST">
                <input type="hidden" name="_token" value="{{ csrf_token('creer_utilisateur') }}">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus me-2"></i>Créer un utilisateur
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newPseudo" class="form-label">Pseudo *</label>
                        <input type="text" class="form-control" id="newPseudo" name="pseudo" required>
                    </div>
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="newEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Mot de passe *</label>
                        <input type="password" class="form-control" id="newPassword" name="password" minlength="8" required>
                        <div class="form-text">Minimum 8 caractères</div>
                    </div>
                    <div class="mb-3">
                        <label for="newRole" class="form-label">Rôle</label>
                        <select class="form-select" id="newRole" name="role">
                            <option value="PASSAGER">Passager</option>
                            <option value="CHAUFFEUR">Chauffeur</option>
                            <option value="CHAUFFEUR_PASSAGER">Chauffeur & Passager</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="newCredits" class="form-label">Crédits initiaux</label>
                        <input type="number" class="form-control" id="newCredits" name="credits" value="20" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Créer</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}